# Java 类加载

## 1、类加载机制的7个阶段

Java虚拟机执行 class 字节码的过程共分为**加载**、**验证**、**准备**、**解析**、**初始化**、**使用**、**卸载**七个阶段

### 1.1、加载

加载阶段是类加载过程的第一个阶段。在这个阶段，JVM 的主要目的是**将字节码从各个位置（网络、磁盘等）转化为二进制字节流加载到内存中**，接着会为**这个类**在 **JVM 的方法区创建一个对应的 Class 对象**，这个 Class 对象就是这个类各种数据的访问入口。

* 加载类数据并在方法区生成对应的 class 对象

### 1.2、校验

加载完成以后，在方法区有对应的对象以后则需要开始对这个对象进行校验：
* **JVM 规范校验**：看是否能被当前版本 JVM 处理
* **代码逻辑校验**：JVM 会对代码组成的数据流和控制流进行校验，确保 JVM 运行该字节码文件后不会出现致命错误。例如一个方法要求传入 int 类型的参数，但是使用它的时候却传入了一个 String 类型的参数。一个方法要求返回 String 类型的结果，但是最后却没有返回结果。代码中引用了一个名为 Apple 的类，但是你实际上却没有定义 Apple 类。

### 1.3、准备

校验完毕以后JVM开始给类分配内存并初始化，这里需要注意两个关键点，即内存分配的对象以及初始化的类型。

* **内存分配的对象**：准备阶段，JVM只为“类变量”（static 修饰的这一部分变量）分配空间，而“成员变量”需要等待初始化才分配空间
* 初始化的类型：准备阶段，JVM会为类变量赋Java初始值（如 int 赋 0），如果是常量则会直接复制，在准备阶段就是代码中的值。


### 1.4、解析

当通过准备阶段之后，JVM 针对**类或接口**、**字段**、**类方法**、**接口方法**、**方法类型**、**方法句柄**和**调用点限定符** 7 类引用进行解析。这个阶段的主要任务是将其在常量池中的符号引用替换成直接其在内存中的直接引用。

* 对程序员透明

### 1.5、初始化

到了初始化阶段，用户定义的 Java 程序代码才真正开始执行。在这个阶段，**JVM 会根据语句执行顺序对类对象进行初始化**，一般来说当 JVM 遇到下面 5 种情况的时候会触发初始化：

* 遇到 new、getstatic、putstatic、invokestatic 这四条字节码指令时，如果类没有进行过初始化，则需要先触发其初始化。生成这4条指令的最常见的Java代码场景是：使用new关键字实例化对象的时候、读取或设置一个类的静态字段（被final修饰、已在编译器把结果放入常量池的静态字段除外）的时候，以及调用一个类的静态方法的时候。
* 使用 java.lang.reflect 包的方法对类进行反射调用的时候，如果类没有进行过初始化，则需要先触发其初始化。
* 当初始化一个类的时候，如果发现其父类还没有进行过初始化，则需要先触发其父类的初始化。
* 当虚拟机启动时，用户需要指定一个要执行的主类（包含main()方法的那个类），虚拟机会先初始化这个主类。
* 当使用 JDK1.7 动态语言支持时，如果一个 java.lang.invoke.MethodHandle实例最后的解析结果 REF_getstatic,REF_putstatic,REF_invokeStatic 的方法句柄，并且这个方法句柄所对应的类没有进行初始化，则需要先出触发其初始化。

简而言之：在类加载过之前
* 第一次 new 该类的对象
* 第一次调用该类的 类（静态）变量 或 类（静态）方法
* 使用反射机制调用其方法或new对象时
* 有 main() 函数的主类

### 6、使用

当初始化完了以后 JVM 便开始从入口方法调用用户的代码

### 7、卸载

当所有代码执行完毕时，JVM便开始销毁已加载的 class 对象

### PS：类初始化方法

在Java字节码中没有构造函数的概念，只有**类初始化方法**与**对象初始化方法**的概念。

* **类初始化方法**：编译器会按照其出现顺序，收集类变量的赋值语句、静态代码块、最终组成类初始化方法。**在类初始化时执行**
* **对象初始化方法**：编译器会按照其出现顺序，收集成员变量的赋值语句、普通代码块，最后收集构造函数的代码，最终组成对象的初始化方法。**在实例话对象的时候执行**

